<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Roadmap Tool - JEC Technologies (Pty) Ltd</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Calibri, sans-serif;
            font-size: 11pt;
            color: #000;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-section, .preview-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .doc-content {
            width: 100%;
            max-width: 8.5in;
            padding: 0.5in;
            box-sizing: border-box;
            font-family: Calibri, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
        }
        .cover-page {
            text-align: center;
            margin-bottom: 40px;
        }
        .cover-page img {
            max-width: 200px;
            margin-bottom: 20px;
        }
        .cover-page h1 {
            font-size: 24pt;
            color: #003087;
            margin: 10px 0;
        }
        .cover-page p {
            font-size: 11pt;
            margin: 5px 0;
            color: #333;
        }
        .toc {
            margin-bottom: 40px;
        }
        .toc h2 {
            font-size: 14pt;
            color: #003087;
            margin-bottom: 10px;
        }
        .toc ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .toc li {
            margin: 5px 0;
            font-size: 11pt;
        }
        .toc li a {
            text-decoration: none;
            color: #000;
        }
        h2, h3, h4, h5 {
            font-weight: bold;
            color: #003087;
            margin: 10px 0;
        }
        h2 { font-size: 14pt; }
        h3 { font-size: 12pt; }
        h4 { font-size: 11pt; }
        h5 { font-size: 10pt; }
        p, ul, li {
            font-size: 11pt;
            margin: 5px 0;
            color: #000;
        }
        ul {
            list-style: disc;
            padding-left: 20px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 11pt;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #003087;
            color: #fff;
            font-weight: bold;
        }
        .header {
            font-size: 10pt;
            color: #666;
            text-align: right;
            margin-bottom: 10px;
        }
        .footer {
            font-size: 10pt;
            color: #666;
            text-align: center;
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        .button {
            background-color: #003087;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .button:hover {
            background-color: #0050b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="font-size: 24pt; text-align: center; color: #003087;">Sales Roadmap Tool - JEC Technologies (Pty) Ltd</h1>

        <!-- Instructions -->
        <div class="form-section">
            <h2 style="font-size: 14pt;">How to Use This Tool</h2>
            <p>1. Add or remove additional products in the "Manage Additional Products" section.<br>
               2. Fill out the client form, select products, and specify quantities.<br>
               3. Click "Generate Roadmap" to create a plan.<br>
               4. Review and download as PDF or HTML (open in Word and save as .docx).</p>
        </div>

        <!-- Product Management Section -->
        <div class="form-section">
            <h2 style="font-size: 14pt;">Manage Additional Products</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input id="newProduct" type="text" placeholder="Add new product" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <button onclick="addProduct()" class="button">Add</button>
            </div>
            <ul id="productList" style="padding-left: 20px;"></ul>
        </div>

        <!-- Client Questions Form -->
        <div class="form-section">
            <h2 style="font-size: 14pt;">Client Questions</h2>
            <form id="clientForm">
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: bold;">Client Name</label>
                    <input type="text" name="clientName" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" required>
                    <p style="color: red; font-size: 10pt; display: none;" class="error">Please enter a client name.</p>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: bold;">Current IT Challenges</label>
                    <textarea name="itChallenges" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 100px;" required></textarea>
                    <p style="color: red; font-size: 10pt; display: none;" class="error">Please describe the IT challenges.</p>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: bold;">Business Goals for Next 12 Months</label>
                    <textarea name="businessGoals" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 100px;" required></textarea>
                    <p style="color: red; font-size: 10pt; display: none;" class="error">Please describe the business goals.</p>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: bold;">Current IT Infrastructure</label>
                    <textarea name="currentInfra" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 100px;" required></textarea>
                    <p style="color: red; font-size: 10pt; display: none;" class="error">Please describe the current infrastructure.</p>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: bold;">Select Products and Quantities</label>
                    <div id="productCheckboxes" style="display: grid; gap: 10px;">
                        <!-- Fixed Managed Services -->
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed Vendors" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed Vendors
                            </label>
                            <input type="number" name="quantity_Managed Vendors" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed Remote Helpdesk (per user)" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed Remote Helpdesk (per user)
                            </label>
                            <input type="number" name="quantity_Managed Remote Helpdesk (per user)" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed Onsite Support technician (in hours)" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed Onsite Support technician (in hours)
                            </label>
                            <input type="number" name="quantity_Managed Onsite Support technician (in hours)" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed M365 instance (per user)" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed M365 instance (per user)
                            </label>
                            <input type="number" name="quantity_Managed M365 instance (per user)" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed Local Area Network Devices" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed Local Area Network Devices
                            </label>
                            <input type="number" name="quantity_Managed Local Area Network Devices" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed Servers" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed Servers
                            </label>
                            <input type="number" name="quantity_Managed Servers" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed Firewalls" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed Firewalls
                            </label>
                            <input type="number" name="quantity_Managed Firewalls" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed Azure IaaS service (per Instance)" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed Azure IaaS service (per Instance)
                            </label>
                            <input type="number" name="quantity_Managed Azure IaaS service (per Instance)" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center;">
                                <input type="checkbox" name="products" value="Managed Cybersecurity & SOC service (per user)" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                                Managed Cybersecurity & SOC service (per user)
                            </label>
                            <input type="number" name="quantity_Managed Cybersecurity & SOC service (per user)" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                        </div>
                    </div>
                    <p id="productError" style="color: red; font-size: 10pt; display: none;">Please select at least one product and specify quantities.</p>
                </div>
                <button type="submit" class="button" style="display: flex; align-items: center;">
                    <span>Generate Roadmap</span>
                    <svg id="loadingSpinner" class="animate-spin" style="width: 20px; height: 20px; margin-left: 8px; display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </button>
            </form>
        </div>

        <!-- Roadmap Preview -->
        <div id="roadmapPreview" class="preview-section" style="display: none;">
            <h2 style="font-size: 14pt;">Roadmap Preview</h2>
            <div id="roadmapContent" class="doc-content"></div>
            <div style="margin-top: 20px;">
                <button onclick="downloadPDF()" class="button">Download as PDF</button>
                <button onclick="downloadWord()" class="button">Download as HTML (Open in Word)</button>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // Preload logo image to avoid CORS issues
        function preloadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = url;
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
            });
        }

        // Fixed Managed Services
        const fixedProducts = [
            "Managed Vendors",
            "Managed Remote Helpdesk (per user)",
            "Managed Onsite Support technician (in hours)",
            "Managed M365 instance (per user)",
            "Managed Local Area Network Devices",
            "Managed Servers",
            "Managed Firewalls",
            "Managed Azure IaaS service (per Instance)",
            "Managed Cybersecurity & SOC service (per user)"
        ];

        // Additional products
        let additionalProducts = JSON.parse(localStorage.getItem('additionalProducts')) || [];

        // Populate product list and checkboxes
        function populateProducts() {
            console.log('Populating products...');
            const productList = document.getElementById('productList');
            const productCheckboxes = document.getElementById('productCheckboxes');
            productCheckboxes.innerHTML = '';
            fixedProducts.forEach(product => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '10px';
                div.innerHTML = `
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" name="products" value="${product}" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                        ${product}
                    </label>
                    <input type="number" name="quantity_${product.replace(/\(/g, '').replace(/\)/g, '')}" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                `;
                productCheckboxes.appendChild(div);
            });

            productList.innerHTML = '';
            additionalProducts.forEach((product, index) => {
                const li = document.createElement('li');
                li.style.margin = '5px 0';
                li.innerHTML = `<span>${product}</span><button onclick="removeProduct(${index})" style="color: red; margin-left: 10px;">Remove</button>`;
                productList.appendChild(li);

                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '10px';
                div.innerHTML = `
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" name="products" value="${product}" style="margin-right: 8px;" onchange="toggleQuantityInput(this)">
                        ${product}
                    </label>
                    <input type="number" name="quantity_${product.replace(/\(/g, '').replace(/\)/g, '')}" class="quantity-input" style="width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="Qty" min="1" disabled>
                `;
                productCheckboxes.appendChild(div);
            });
            console.log('Products populated:', fixedProducts.length + additionalProducts.length);
        }

        // Toggle quantity input
        function toggleQuantityInput(checkbox) {
            console.log('Toggling quantity input for:', checkbox.value);
            const quantityInput = checkbox.parentElement.nextElementSibling;
            if (quantityInput) {
                if (checkbox.checked) {
                    quantityInput.style.display = 'block';
                    quantityInput.disabled = false;
                } else {
                    quantityInput.style.display = 'none';
                    quantityInput.disabled = true;
                    quantityInput.value = '';
                }
            } else {
                console.error('Quantity input not found for:', checkbox.value);
            }
        }

        // Add new product
        function addProduct() {
            console.log('Adding new product...');
            const newProduct = document.getElementById('newProduct').value.trim();
            if (newProduct && !additionalProducts.includes(newProduct) && !fixedProducts.includes(newProduct)) {
                additionalProducts.push(newProduct);
                localStorage.setItem('additionalProducts', JSON.stringify(additionalProducts));
                document.getElementById('newProduct').value = '';
                populateProducts();
                console.log('New product added:', newProduct);
            } else if (fixedProducts.includes(newProduct)) {
                alert('This product is already a fixed Managed Service.');
                console.log('Product already exists:', newProduct);
            }
        }

        // Remove product
        function removeProduct(index) {
            console.log('Removing product at index:', index);
            additionalProducts.splice(index, 1);
            localStorage.setItem('additionalProducts', JSON.stringify(additionalProducts));
            populateProducts();
            console.log('Product removed, remaining count:', additionalProducts.length);
        }

        // Validate form
        function validateForm(formData) {
            console.log('Validating form...');
            let isValid = true;
            document.querySelectorAll('.error').forEach(error => error.style.display = 'none');
            document.getElementById('productError').style.display = 'none';

            ['clientName', 'itChallenges', 'businessGoals', 'currentInfra'].forEach(field => {
                if (!formData.get(field)) {
                    const input = document.querySelector(`[name="${field}"]`);
                    input.nextElementSibling.style.display = 'block';
                    isValid = false;
                    console.log('Validation failed for field:', field);
                }
            });

            const selectedProducts = formData.getAll('products').map(product => ({
                product,
                quantity: formData.get(`quantity_${product.replace(/\(/g, '').replace(/\)/g, '')}`)
            })).filter(p => p.quantity > 0);
            console.log('Selected products:', selectedProducts);

            if (selectedProducts.length === 0) {
                document.getElementById('productError').style.display = 'block';
                isValid = false;
                console.log('No products selected');
            }

            return { isValid, selectedProducts };
        }

        // Form submission
        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            console.log('Form submission started...');
            try {
                e.preventDefault();
                const spinner = document.getElementById('loadingSpinner');
                spinner.style.display = 'block';

                const formData = new FormData(this);
                const { isValid, selectedProducts } = validateForm(formData);
                console.log('Validation result:', { isValid, selectedProducts });

                if (!isValid) {
                    spinner.style.display = 'none';
                    return;
                }

                const data = {
                    clientName: formData.get('clientName'),
                    itChallenges: formData.get('itChallenges'),
                    businessGoals: formData.get('businessGoals'),
                    currentInfra: formData.get('currentInfra'),
                    products: selectedProducts
                };
                console.log('Form data prepared:', JSON.stringify(data, null, 2));

                const response = await fetch('https://sales-roadmap-tool.netlify.app/.netlify/functions/generate-roadmap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                console.log('Fetch response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const { roadmap } = await response.json();
                console.log('AI-generated roadmap received:', JSON.stringify(roadmap, null, 2));

                // Preload logo image
                const logoUrl = 'https://raw.githubusercontent.com/MushiDee/sales-roadmap-tool/main/images/logo.png';
                await preloadImage(logoUrl).catch(err => {
                    console.error('Failed to preload logo:', err);
                });

                const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                let roadmapContent = '';
                console.log('Building roadmap content...');

                // Cover page
                roadmapContent += '<div class="cover-page">';
                roadmapContent += `<img src="${logoUrl}" alt="JEC Technologies Logo" style="max-width: 200px;" onerror="this.src=\'https://via.placeholder.com/200x50.png?text=JEC+Technologies+Logo\';">`;
                roadmapContent += '<h1 style="font-size: 24pt;">IT Roadmap and Strategy</h1>';
                roadmapContent += `<p style="font-size: 14pt;">Prepared for ${data.clientName}</p>`;
                roadmapContent += '<p>Prepared by: JEC Technologies (Pty) Ltd</p>';
                roadmapContent += '<p>Contact: info@jectech.co.za | (+27) 123-456-7890</p>';
                roadmapContent += `<p>Date: ${currentDate}</p>`;
                roadmapContent += '</div>';

                // Table of Contents
                roadmapContent += '<div class="toc">';
                roadmapContent += '<h2 style="font-size: 14pt;">Table of Contents</h2>';
                roadmapContent += '<ul>';
                roadmapContent += '<li><a href="#overview">1. Executive Summary</a></li>';
                roadmapContent += '<li><a href="#client">2. Client Overview</a></li>';
                roadmapContent += '<li><a href="#roadmap">3. Implementation Roadmap</a></li>';
                roadmapContent += '<li><a href="#nextsteps">4. Next Steps</a></li>';
                roadmapContent += '</ul>';
                roadmapContent += '</div>';

                // Executive Summary
                roadmapContent += '<div id="overview">';
                roadmapContent += '<h2 style="font-size: 14pt;">1. Executive Summary</h2>';
                roadmapContent += '<p>This roadmap outlines a strategic 12-month plan to address ' + data.clientName + '\'s IT challenges and achieve their business goals through tailored managed services. By leveraging JEC Technologies (Pty) Ltd\'s expertise, we aim to enhance system reliability, security, and scalability.</p>';
                roadmapContent += '</div>';

                // Client Overview
                roadmapContent += '<div id="client">';
                roadmapContent += '<h2 style="font-size: 14pt;">2. Client Overview</h2>';
                roadmapContent += '<h3 style="font-size: 12pt;">Client Name</h3>';
                roadmapContent += '<p>' + data.clientName + '</p>';
                roadmapContent += '<h3 style="font-size: 12pt;">Current IT Challenges</h3>';
                roadmapContent += '<p>' + data.itChallenges.replace(/\n/g, '<br>') + '</p>';
                roadmapContent += '<h3 style="font-size: 12pt;">Business Goals (Next 12 Months)</h3>';
                roadmapContent += '<p>' + data.businessGoals.replace(/\n/g, '<br>') + '</p>';
                roadmapContent += '<h3 style="font-size: 12pt;">Current IT Infrastructure</h3>';
                roadmapContent += '<p>' + data.currentInfra.replace(/\n/g, '<br>') + '</p>';
                roadmapContent += '<h3 style="font-size: 12pt;">Recommended Products</h3>';
                roadmapContent += '<ul style="padding-left: 20px;">';
                data.products.forEach(p => {
                    roadmapContent += '<li>' + p.product + ' (' + (p.quantity || '0') + ' units)</li>';
                });
                roadmapContent += '</ul>';
                roadmapContent += '</div>';

                // Implementation Roadmap
                roadmapContent += '<div id="roadmap">';
                roadmapContent += '<h2 style="font-size: 14pt;">3. Implementation Roadmap</h2>';
                roadmap.milestones.forEach((milestone, index) => {
                    roadmapContent += '<div>';
                    roadmapContent += '<h3 style="font-size: 12pt;">3.' + (index + 1) + ' Milestone ' + (index + 1) + ': ' + milestone.name + ' (' + milestone.timeframe + ')</h3>';
                    roadmapContent += '<h4 style="font-size: 11pt;">Products Utilized</h4>';
                    roadmapContent += '<p>' + (milestone.productsUsed ? milestone.productsUsed.join(', ') : 'None') + '</p>';
                    roadmapContent += '<h4 style="font-size: 11pt;">What We’ll Deliver</h4>';
                    roadmapContent += '<ul style="padding-left: 20px;">';
                    milestone.deliverables.forEach(d => {
                        roadmapContent += '<li>' + d + '</li>';
                    });
                    roadmapContent += '</ul>';
                    roadmapContent += '<h4 style="font-size: 11pt;">How We’ll Do It</h4>';
                    roadmapContent += '<p>' + milestone.approach + '</p>';
                    roadmapContent += '<h4 style="font-size: 11pt;">Project Plan</h4>';
                    roadmapContent += '<table style="width: 100%; border-collapse: collapse;">';
                    roadmapContent += '<tr>';
                    roadmapContent += '<th style="border: 1px solid #ccc; padding: 8px; background-color: #003087; color: #fff;">Task</th>';
                    roadmapContent += '<th style="border: 1px solid #ccc; padding: 8px; background-color: #003087; color: #fff;">Timeline</th>';
                    roadmapContent += '<th style="border: 1px solid #ccc; padding: 8px; background-color: #003087; color: #fff;">Effort (Hours)</th>';
                    roadmapContent += '<th style="border: 1px solid #ccc; padding: 8px; background-color: #003087; color: #fff;">Product</th>';
                    roadmapContent += '<th style="border: 1px solid #ccc; padding: 8px; background-color: #003087; color: #fff;">Dependencies</th>';
                    roadmapContent += '</tr>';
                    if (milestone.projectPlan && milestone.projectPlan.length > 0) {
                        milestone.projectPlan.forEach(p => {
                            roadmapContent += '<tr>';
                            roadmapContent += '<td style="border: 1px solid #ccc; padding: 8px;">' + p.task + '</td>';
                            roadmapContent += '<td style="border: 1px solid #ccc; padding: 8px;">' + p.timeline + '</td>';
                            roadmapContent += '<td style="border: 1px solid #ccc; padding: 8px;">' + p.effortHours + '</td>';
                            roadmapContent += '<td style="border: 1px solid #ccc; padding: 8px;">' + p.product + '</td>';
                            roadmapContent += '<td style="border: 1px solid #ccc; padding: 8px;">' + p.dependencies + '</td>';
                            roadmapContent += '</tr>';
                        });
                    } else {
                        roadmapContent += '<tr><td colspan="5" style="border: 1px solid #ccc; padding: 8px;">No project plan provided</td></tr>';
                    }
                    roadmapContent += '</table>';
                    roadmapContent += '<h4 style="font-size: 11pt;">Best Practices</h4>';
                    roadmapContent += '<ul style="padding-left: 20px;">';
                    if (milestone.bestPractices && milestone.bestPractices.length > 0) {
                        milestone.bestPractices.forEach(b => {
                            roadmapContent += '<li>' + b.product + ': ' + b.guideline + '</li>';
                        });
                    } else {
                        roadmapContent += '<li>No best practices provided</li>';
                    }
                    roadmapContent += '</ul>';
                    roadmapContent += '<h4 style="font-size: 11pt;">Potential Risks</h4>';
                    roadmapContent += '<ul style="padding-left: 20px;">';
                    milestone.risks.forEach(r => {
                        roadmapContent += '<li>' + r + '</li>';
                    });
                    roadmapContent += '</ul>';
                    roadmapContent += '<h4 style="font-size: 11pt;">Success Metrics</h4>';
                    roadmapContent += '<ul style="padding-left: 20px;">';
                    milestone.kpis.forEach(k => {
                        roadmapContent += '<li>' + k + '</li>';
                    });
                    roadmapContent += '</ul>';
                    roadmapContent += '</div>';
                });
                roadmapContent += '<div id="nextsteps">';
                roadmapContent += '<h2 style="font-size: 14pt;">4. Next Steps</h2>';
                roadmapContent += '<p>' + roadmap.nextSteps + '</p>';
                roadmapContent += '</div>';
                roadmapContent += '<div class="footer">';
                roadmapContent += '<p>JEC Technologies (Pty) Ltd | IT Roadmap for ' + data.clientName + ' | Page <span class="page-number"></span> | ' + currentDate + '</p>';
                roadmapContent += '</div>';

                const roadmapContentDiv = document.getElementById('roadmapContent');
                try {
                    console.log('Setting roadmap content...');
                    roadmapContentDiv.innerHTML = roadmapContent;
                    console.log('Roadmap content set:', roadmapContent.substring(0, 100) + '...');
                    document.getElementById('roadmapPreview').style.display = 'block';
                } catch (error) {
                    console.error('Error setting roadmap content:', error);
                    alert('Failed to set roadmap content due to a syntax error. Check console logs.');
                }
            } catch (error) {
                console.error('Error generating roadmap:', error);
                alert('Failed to generate roadmap. Please check your Netlify Function setup or contact support.');
            } finally {
                spinner.style.display = 'none';
            }
        });

        // Download PDF
        async function downloadPDF() {
            console.log('Starting PDF generation...');
            const sourceElement = document.getElementById('roadmapContent');
            console.log('Source content for PDF:', sourceElement ? sourceElement.innerHTML.substring(0, 100) + '...' : 'null');

            try {
                setTimeout(async () => {
                    console.log('Executing html2canvas...');
                    const canvas = await html2canvas(sourceElement, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        windowHeight: sourceElement ? sourceElement.scrollHeight : 0
                    });
                    console.log('Canvas dimensions:', canvas.width, canvas.height);
                    if (canvas.width === 0 || canvas.height === 0) {
                        throw new Error('Canvas rendering produced an empty result');
                    }
                    const imgData = canvas.toDataURL('image/png');
                    console.log('Image data generated:', imgData.substring(0, 50) + '...');
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'in',
                        format: 'letter'
                    });

                    const imgProps = pdf.getImageProperties(imgData);
                    console.log('Image properties:', imgProps);
                    const pdfWidth = pdf.internal.pageSize.getWidth() - 1; // 1 inch margins
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    let heightLeft = pdfHeight;
                    let position = 0.5; // Start at 0.5 inch from top

                    console.log('Adding first image to PDF...');
                    pdf.addImage(imgData, 'PNG', 0.5, position, pdfWidth, pdfHeight);
                    heightLeft -= pdf.internal.pageSize.getHeight() - 1;

                    while (heightLeft > 0) {
                        console.log('Adding new page to PDF...');
                        pdf.addPage();
                        position = 0.5 - (pdfHeight - heightLeft);
                        pdf.addImage(imgData, 'PNG', 0.5, position, pdfWidth, pdfHeight);
                        heightLeft -= pdf.internal.pageSize.getHeight() - 1;
                    }

                    console.log('Saving PDF...');
                    pdf.save('Roadmap_Strategy.pdf');
                    console.log('PDF generated successfully');
                }, 4000);
            } catch (err) {
                console.error('PDF generation error:', err);
                alert('Failed to generate PDF due to rendering issues. Please try again.');
            }
        }

        // Download Word (Simplified HTML export as .html for Word)
        function downloadWord() {
            console.log('Starting Word generation...');
            const sourceElement = document.getElementById('roadmapContent');
            console.log('Source content for Word:', sourceElement ? sourceElement.innerHTML.substring(0, 100) + '...' : 'null');

            const clientName = document.querySelector('[name="clientName"]').value;
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const header = `
                <div class="header">
                    <p>JEC Technologies (Pty) Ltd | IT Roadmap for ${clientName} | ${currentDate}</p>
                </div>
            `;
            const content = header + (sourceElement ? sourceElement.innerHTML : '');
            const escapedContent = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
            const docContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>IT Roadmap for ${clientName}</title>
                    <style>
                        body { font-family: Calibri, sans-serif; font-size: 11pt; color: #000; margin: 0.5in; }
                        h1 { font-size: 24pt; color: #003087; }
                        h2 { font-size: 14pt; color: #003087; }
                        h3 { font-size: 12pt; color: #003087; }
                        h4 { font-size: 11pt; color: #003087; }
                        h5 { font-size: 10pt; color: #003087; }
                        p, ul, li { font-size: 11pt; margin: 5px 0; }
                        ul { padding-left: 20px; list-style: disc; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ccc; padding: 8px; }
                        th { background-color: #003087; color: #fff; }
                        .header { font-size: 10pt; color: #666; text-align: right; }
                        .footer { font-size: 10pt; color: #666; text-align: center; border-top: 1px solid #ccc; padding-top: 10px; }
                        img { max-width: 200px; }
                        .cover-page { text-align: center; margin-bottom: 40px; }
                        .toc ul { list-style: none; padding: 0; }
                    </style>
                </head>
                <body>${escapedContent}</body>
                </html>
            `;

            try {
                console.log('Creating Word document...');
                const blob = new Blob([docContent], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Roadmap_Strategy.html';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                console.log('Word document generated successfully');
                alert('HTML file generated. Open in Microsoft Word and save as .docx for best results.');
            } catch (err) {
                console.error('Word generation error:', err);
                alert('Failed to generate Word document. Please try again or download as PDF.');
            }
        }

        // Initialize products
        populateProducts();
    </script>
</body>
</html>